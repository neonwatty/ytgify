name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Run type checking
      run: npm run typecheck

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: tests/coverage/
        retention-days: 7

    - name: Build extension
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-build
        path: dist/
        retention-days: 7

    - name: Check coverage thresholds
      run: |
        coverage_output=$(npm run test:coverage 2>&1)
        echo "$coverage_output"

        # Extract coverage percentage
        coverage=$(echo "$coverage_output" | grep "All files" | awk '{print $3}' | sed 's/%//')

        # Check if coverage is above threshold (60%)
        if (( $(echo "$coverage < 60" | bc -l) )); then
          echo "❌ Coverage is below 60% threshold: ${coverage}%"
          exit 1
        else
          echo "✅ Coverage is above threshold: ${coverage}%"
        fi