<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test wasm-webp Animated WebP in Browser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    video {
      width: 100%;
      max-width: 400px;
    }
    img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      margin-top: 10px;
    }
    .info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
    }
    .error {
      color: red;
      padding: 10px;
      background: #ffe0e0;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      color: green;
      padding: 10px;
      background: #e0ffe0;
      border-radius: 4px;
      margin-top: 10px;
    }
    #status {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Test wasm-webp Animated WebP in Browser</h1>
  
  <div class="container">
    <div class="card">
      <h2>Input</h2>
      <video id="testVideo" controls>
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
      </video>
      <div>
        <button onclick="testDirectWasmWebP()">Test Direct wasm-webp</button>
        <button onclick="testWithModuleLoader()">Test with Module Loader</button>
        <button onclick="testManualFrames()">Test Manual Frame Capture</button>
      </div>
      <div id="inputInfo"></div>
    </div>
    
    <div class="card">
      <h2>Output</h2>
      <div id="output"></div>
      <div id="status"></div>
    </div>
  </div>

  <script type="module">
    window.log = function(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      statusDiv.appendChild(entry);
      console.log(message);
    };

    // Test direct import of wasm-webp
    window.testDirectWasmWebP = async function() {
      const outputDiv = document.getElementById('output');
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '';
      outputDiv.innerHTML = '<p>Testing direct wasm-webp import...</p>';
      
      try {
        log('Attempting to import wasm-webp module...');
        
        // Try to load the module directly
        const script = document.createElement('script');
        script.type = 'module';
        script.textContent = `
          import { encodeAnimation } from './node_modules/wasm-webp/dist/esm/index.js';
          window.wasmWebpEncodeAnimation = encodeAnimation;
        `;
        document.head.appendChild(script);
        
        // Wait a bit for module to load
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (!window.wasmWebpEncodeAnimation) {
          throw new Error('Failed to load encodeAnimation function');
        }
        
        log('Module loaded successfully!', 'success');
        
        // Now try to create animated WebP
        await createAnimatedWebP(window.wasmWebpEncodeAnimation);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test with manual module loader
    window.testWithModuleLoader = async function() {
      const outputDiv = document.getElementById('output');
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '';
      outputDiv.innerHTML = '<p>Testing with module loader...</p>';
      
      try {
        log('Loading wasm-webp CommonJS version...');
        
        // Try CommonJS version
        const response = await fetch('./node_modules/wasm-webp/dist/cjs/index.js');
        const text = await response.text();
        log(`Loaded module code (${text.length} bytes)`, 'success');
        
        // This won't work directly but shows the module exists
        log('Note: CommonJS module requires Node.js environment', 'info');
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    };

    // Test manual frame capture and WebP creation
    window.testManualFrames = async function() {
      const outputDiv = document.getElementById('output');
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '';
      outputDiv.innerHTML = '<p>Testing manual frame capture...</p>';
      
      try {
        const video = document.getElementById('testVideo');
        
        // Capture frames manually
        log('Capturing frames from video...');
        const frames = await captureFrames(video, 5); // Capture 5 frames
        log(`Captured ${frames.length} frames`, 'success');
        
        // Try to create animated WebP using Canvas API fallback
        log('Creating animated WebP (Canvas API fallback)...');
        
        // Since we can't create true animated WebP in browser,
        // show what we captured and create single frame
        const canvas = document.createElement('canvas');
        canvas.width = 320;
        canvas.height = 240;
        const ctx = canvas.getContext('2d');
        
        // Draw first frame
        const imageData = new ImageData(
          new Uint8ClampedArray(frames[0].data),
          canvas.width,
          canvas.height
        );
        ctx.putImageData(imageData, 0, 0);
        
        // Convert to WebP
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/webp', 0.85);
        });
        
        const url = URL.createObjectURL(blob);
        outputDiv.innerHTML = `
          <div class="info">
            <strong>Result:</strong><br>
            Frames captured: ${frames.length}<br>
            Output: Single-frame WebP (browser limitation)<br>
            Size: ${(blob.size / 1024).toFixed(1)} KB<br>
            <br>
            <strong>Note:</strong> True animated WebP requires server-side processing
          </div>
          <img src="${url}" alt="WebP output">
        `;
        
        log('Single-frame WebP created (animation requires server)', 'info');
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    };

    // Helper function to capture frames
    async function captureFrames(video, count = 10) {
      const frames = [];
      const canvas = document.createElement('canvas');
      canvas.width = 320;
      canvas.height = 240;
      const ctx = canvas.getContext('2d');
      
      const duration = video.duration;
      const interval = duration / count;
      
      for (let i = 0; i < count; i++) {
        const time = i * interval;
        
        // Seek to time
        await new Promise(resolve => {
          const onSeeked = () => {
            video.removeEventListener('seeked', onSeeked);
            resolve();
          };
          video.addEventListener('seeked', onSeeked);
          video.currentTime = time;
        });
        
        // Capture frame
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        frames.push({
          data: new Uint8Array(imageData.data.buffer),
          duration: interval * 1000 // Convert to ms
        });
      }
      
      return frames;
    }

    // Try to create animated WebP if module loaded
    async function createAnimatedWebP(encodeAnimation) {
      const video = document.getElementById('testVideo');
      const outputDiv = document.getElementById('output');
      
      log('Capturing frames for animated WebP...');
      const frames = await captureFrames(video, 10);
      
      log('Encoding animated WebP...');
      const webpData = await encodeAnimation(320, 240, true, frames);
      
      if (!webpData) {
        throw new Error('Failed to encode WebP');
      }
      
      const blob = new Blob([webpData], { type: 'image/webp' });
      const url = URL.createObjectURL(blob);
      
      outputDiv.innerHTML = `
        <div class="success">
          Animated WebP created successfully!<br>
          Size: ${(blob.size / 1024).toFixed(1)} KB
        </div>
        <img src="${url}" alt="Animated WebP">
      `;
      
      log('Animated WebP created!', 'success');
    }
  </script>
</body>
</html>