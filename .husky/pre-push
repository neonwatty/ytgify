#!/usr/bin/env sh

echo "🚨 Running mandatory pre-push validation..."
echo "⚠️  This will take 3-5 minutes to ensure code quality before pushing to remote"
echo ""

# Run full linting
echo "📝 Running ESLint..."
npm run lint

# Build the extension
echo "🔨 Building extension..."
npm run build

# Verify extension build
if [ ! -f "dist/manifest.json" ]; then
  echo "❌ Extension build failed - manifest.json not found"
  echo "💡 Run 'npm run build' to fix this issue"
  exit 1
fi

echo "✅ Extension built successfully"

# Run type checking
echo "🔍 Running TypeScript type check..."
npm run typecheck

# Run unit tests
echo "🧪 Running unit tests..."
npm test

# Run E2E tests (mandatory - no bypass allowed)
echo ""
echo "🎭 Running E2E tests (wizard-basic.spec.ts with 3 parallel workers)..."
echo "⚠️  This ensures extension works on real YouTube pages"
echo "📍 Tests require Chrome browser and internet connection"
echo "🚀 Running with 3 workers for faster execution"

npm run test:e2e:fast

if [ $? -ne 0 ]; then
  echo ""
  echo "❌ E2E tests failed!"
  echo ""
  echo "💡 Tips for fixing E2E test failures:"
  echo "   • Ensure Chrome browser is available"
  echo "   • Check your internet connection"
  echo "   • Run 'npm run test:e2e:headed -- tests/e2e/wizard-basic.spec.ts' to see what's happening"
  echo "   • Run 'npm run test:e2e:debug -- tests/e2e/wizard-basic.spec.ts' for detailed debugging"
  echo ""
  echo "🚫 Push blocked - wizard-basic E2E tests must pass before pushing"
  exit 1
fi

echo ""
echo "✅ All pre-push checks passed!"
echo "🎉 Your code is ready to push - all tests verified"