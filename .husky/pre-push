#!/usr/bin/env sh

echo "ğŸš€ Running pre-push checks..."

# Run linting
echo "ğŸ“ Running ESLint..."
npm run lint

# Ensure extension is built before running E2E tests
echo "ğŸ”¨ Building extension..."
npm run build

# Verify extension build
if [ ! -f "dist/manifest.json" ]; then
  echo "âŒ Extension build failed - manifest.json not found"
  echo "ğŸ’¡ Run 'npm run build' to fix this issue"
  exit 1
fi

echo "âœ… Extension built successfully"

# Run type checking
echo "ğŸ” Running TypeScript type check..."
npm run typecheck

# Run unit tests
echo "ğŸ§ª Running unit tests..."
npm test

# Run E2E tests (mandatory - no bypass allowed)
echo "ğŸ­ Running E2E tests (wizard-basic.spec.ts with 3 parallel workers)..."
echo "âš ï¸  This may take a few minutes and requires Chrome browser"
echo "ğŸ“ Testing extension functionality on real YouTube pages"
echo "ğŸš€ Running with 3 workers for faster execution"

npm run test:e2e:fast

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ E2E tests failed!"
  echo ""
  echo "ğŸ’¡ Tips for fixing E2E test failures:"
  echo "   â€¢ Ensure Chrome browser is available"
  echo "   â€¢ Check your internet connection"
  echo "   â€¢ Run 'npm run test:e2e:headed -- tests/e2e/wizard-basic.spec.ts' to see what's happening"
  echo "   â€¢ Run 'npm run test:e2e:debug -- tests/e2e/wizard-basic.spec.ts' for detailed debugging"
  echo ""
  echo "ğŸš« Push blocked - wizard-basic E2E tests must pass before pushing"
  exit 1
fi

echo ""
echo "âœ… All pre-push checks passed!"
echo "ğŸ‰ Ready to push to remote repository"