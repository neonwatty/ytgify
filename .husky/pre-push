#!/usr/bin/env sh

echo "🚀 Running pre-push checks..."

# Ensure extension is built before running E2E tests
echo "🔨 Building extension..."
npm run build

# Verify extension build
if [ ! -f "dist/manifest.json" ]; then
  echo "❌ Extension build failed - manifest.json not found"
  echo "💡 Run 'npm run build' to fix this issue"
  exit 1
fi

echo "✅ Extension built successfully"

# Run type checking
echo "🔍 Running TypeScript type check..."
npm run typecheck

# Run unit tests
echo "🧪 Running unit tests..."
npm test

# Run E2E tests (mandatory - no bypass allowed)
echo "🎭 Running E2E tests (wizard-basic.spec.ts)..."
echo "⚠️  This may take a few minutes and requires Chrome browser"
echo "📍 Testing extension functionality on real YouTube pages"

npm run test:e2e -- tests/e2e/wizard-basic.spec.ts

if [ $? -ne 0 ]; then
  echo ""
  echo "❌ E2E tests failed!"
  echo ""
  echo "💡 Tips for fixing E2E test failures:"
  echo "   • Ensure Chrome browser is available"
  echo "   • Check your internet connection"
  echo "   • Run 'npm run test:e2e:headed -- tests/e2e/wizard-basic.spec.ts' to see what's happening"
  echo "   • Run 'npm run test:e2e:debug -- tests/e2e/wizard-basic.spec.ts' for detailed debugging"
  echo ""
  echo "🚫 Push blocked - wizard-basic E2E tests must pass before pushing"
  exit 1
fi

echo ""
echo "✅ All pre-push checks passed!"
echo "🎉 Ready to push to remote repository"