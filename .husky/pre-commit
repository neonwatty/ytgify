#!/usr/bin/env sh

echo "ğŸš¨ Running mandatory pre-commit validation..."
echo "âš ï¸  This will take 3-5 minutes to ensure code quality"
echo ""

# Run linting on staged files
echo "ğŸ“ Running ESLint on staged files..."
npx lint-staged

# Build the extension
echo "ğŸ”¨ Building extension..."
npm run build

# Verify extension build
if [ ! -f "dist/manifest.json" ]; then
  echo "âŒ Extension build failed - manifest.json not found"
  echo "ğŸ’¡ Run 'npm run build' to fix this issue"
  exit 1
fi

echo "âœ… Extension built successfully"

# Run type checking
echo "ğŸ” Running TypeScript type check..."
npm run typecheck

# Run unit tests
echo "ğŸ§ª Running unit tests..."
npm test

# Run E2E tests (mandatory - no bypass allowed)
echo ""
echo "ğŸ­ Running E2E tests (wizard-basic.spec.ts with 3 parallel workers)..."
echo "âš ï¸  This ensures extension works on real YouTube pages"
echo "ğŸ“ Tests require Chrome browser and internet connection"
echo "ğŸš€ Running with 3 workers for faster execution"

npm run test:e2e:fast

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ E2E tests failed!"
  echo ""
  echo "ğŸ’¡ Tips for fixing E2E test failures:"
  echo "   â€¢ Ensure Chrome browser is available"
  echo "   â€¢ Check your internet connection"
  echo "   â€¢ Run 'npm run test:e2e:headed -- tests/e2e/wizard-basic.spec.ts' to see what's happening"
  echo "   â€¢ Run 'npm run test:e2e:debug -- tests/e2e/wizard-basic.spec.ts' for detailed debugging"
  echo ""
  echo "ğŸš« Commit blocked - wizard-basic E2E tests must pass before committing"
  exit 1
fi

echo ""
echo "âœ… All pre-commit checks passed!"
echo "ğŸ‰ Your commit is ready - all tests verified"